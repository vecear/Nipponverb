import re
import os

files_to_update = [
    'src/data/details/n5.ts',
    'src/data/questions/n5.ts'
]

# Replacement Dictionary (Kanji -> Annotated)
# Sorted roughly by specificity/length will be handled by sorting keys later.
replacements = {
    # Pronouns & People
    "私": "私{わたし}",
    "僕": "僕{ぼく}",
    "彼": "彼{かれ}",
    "彼女": "彼{かの}女{じょ}",
    "あなた": "あなた", # No kanji usually, or 貴方
    "田中": "田{た}中{なか}",
    "山田": "山{やま}田{だ}",
    "鈴木": "鈴{すず}木{き}",
    "佐藤": "佐{さ}藤{とう}",
    "先生": "先{せん}生{せい}",
    "学生": "学{がく}生{せい}",
    "留学生": "留{りゅう}学{がく}生{せい}",
    "医者": "医{い}者{しゃ}",
    "会社員": "会{かい}社{しゃ}員{いん}",
    "社員": "社{しゃ}員{いん}",
    "人": "人{ひと}",
    "男の人": "男{おとこ}の人{ひと}",
    "女の人": "女{おんな}の人{ひと}",
    "男の子": "男{おとこ}の子{こ}",
    "女の子": "女{おんな}の子{こ}",
    "子供": "子{こ}供{ども}",
    "大人": "大{おと}人{な}",
    "父": "父{ちち}",
    "母": "母{はは}",
    "お父さん": "お父{とう}さん",
    "お母さん": "お母{かあ}さん",
    "主人": "主{しゅ}人{じん}",
    "兄弟": "兄{きょう}弟{だい}",
    "妹": "妹{いもうと}",
    "弟": "弟{おとうと}",
    "姉": "姉{あね}",
    "兄": "兄{あに}",
    "家族": "家{か}族{ぞく}",
    "友達": "友{とも}達{だち}",
    "日本人": "日{に}本{ほん}人{じん}",
    "外国人": "外{がい}国{こく}人{じん}",
    "一人": "一{ひと}人{り}",
    "二人": "二{ふた}人{り}",
    "三人": "三{さん}人{にん}",
    "皆さん": "皆{みな}さん",
    "誰": "誰{だれ}",
    
    # Time
    "今日": "今{きょう}日{_}", # Special rendering? Usually 今日{きょう} is fine if supported, or 今日{きょう}
    "今日": "今日{きょう}",
    "昨日": "昨{き}日{のう}",
    "明日": "明{あし}日{た}",
    "毎日": "毎{まい}日{にち}",
    "毎朝": "毎{まい}朝{あさ}",
    "毎晩": "毎{まい}晩{ばん}",
    "毎週": "毎{まい}週{しゅう}",
    "今週": "今{こん}週{しゅう}",
    "来週": "来{らい}週{しゅう}",
    "先週": "先{せん}週{しゅう}",
    "今年": "今{こ}年{とし}",
    "来年": "来{らい}年{ねん}",
    "去年": "去{きょ}年{ねん}",
    "朝": "朝{あさ}",
    "昼": "昼{ひる}",
    "晩": "晩{ばん}",
    "夜": "夜{よる}",
    "午前": "午{ご}前{ぜん}",
    "午後": "午{ご}後{ご}",
    "時間": "時{じ}間{かん}",
    "時": "時{じ}",
    "分": "分{ふん}",
    "半": "半{はん}",
    "曜日": "曜{よう}日{び}",
    "月曜日": "月{げつ}曜{よう}日{び}",
    "火曜日": "火{か}曜{よう}日{び}",
    "水曜日": "水{すい}曜{よう}日{び}",
    "木曜日": "木{もく}曜{よう}日{び}",
    "金曜日": "金{きん}曜{よう}日{び}",
    "土曜日": "土{ど}曜{よう}日{び}",
    "日曜日": "日{にち}曜{よう}日{び}",
    "何時": "何{なん}時{じ}",
    "いつ": "いつ",
    "誕生日": "誕{たん}生{じょう}日{び}",
    "夏休み": "夏{なつ}休{やす}み",
    "休み": "休{やす}み",
    "今": "今{いま}",
    "昔": "昔{むかし}",
    "後で": "後{あと}で",
    "前に": "前{まえ}に",
    "時々": "時{とき}々{どき}",
    
    # Places & Transport
    "学校": "学{がっ}校{こう}",
    "大学": "大{だい}学{がく}",
    "高校": "高{こう}校{こう}",
    "教室": "教{きょう}室{しつ}",
    "部屋": "部{へ}屋{や}",
    "食堂": "食{しょく}堂{どう}",
    "銀行": "銀{ぎん}行{こう}",
    "病院": "病{びょう}院{いん}",
    "郵便局": "郵{ゆう}便{びん}局{きょく}",
    "図書館": "図{と}書{しょ}館{かん}",
    "美術館": "美{び}術{じゅ}つ館{かん}",
    "公園": "公{こう}園{えん}",
    "駅": "駅{えき}",
    "駅前": "駅{えき}前{まえ}",
    "店": "店{みせ}",
    "会社": "会{かい}社{しゃ}",
    "事務所": "事{じ}務{む}所{しょ}",
    "家": "家{いえ}",
    "池": "池{いけ}",
    "川": "川{かわ}",
    "山": "山{やま}",
    "海": "海{うみ}",
    "世界": "世{せ}界{かい}",
    "東京": "東{とう}京{きょう}",
    "日本": "日{に}本{ほん}",
    "外国": "外{がい}国{こく}",
    "国": "国{くに}",
    "町": "町{まち}",
    "交番": "交{こう}番{ばん}",
    "入り口": "入{い}り口{ぐち}",
    "出口": "出{で}口{ぐち}",
    "電車": "電{でん}車{しゃ}",
    "地下鉄": "地{ち}下{か}鉄{てつ}",
    "新幹線": "新{しん}幹{かん}線{せん}",
    "バス": "バス",
    "タクシー": "タクシー",
    "自転車": "自{じ}転{てん}車{しゃ}",
    "自動車": "自{じ}動{どう}車{しゃ}",
    "飛行機": "飛{ひ}行{こう}機{き}",
    "船": "船{ふね}",
    "歩いて": "歩{ある}いて",
    
    # Things
    "本": "本{ほん}",
    "辞書": "辞{じ}書{しょ}",
    "雑誌": "雑{ざっ}誌{し}",
    "新聞": "新{しん}聞{ぶん}",
    "手帳": "手{て}帳{ちょう}",
    "名刺": "名{めい}刺{し}",
    "鉛筆": "鉛{えん}筆{ぴつ}",
    "時計": "時{と}計{けい}",
    "傘": "傘{かさ}",
    "鞄": "鞄{かばん}",
    "財布": "財{さい}布{ふ}",
    "鍵": "鍵{かぎ}",
    "車": "車{くるま}",
    "机": "机{つくえ}",
    "椅子": "椅{い}子{す}",
    "お土産": "お土{みや}産{げ}",
    "電話": "電{でん}話{わ}",
    "靴": "靴{くつ}",
    "眼鏡": "眼{め}鏡{がね}",
    "薬": "薬{くすり}",
    "水": "水{みず}",
    "お湯": "お湯{ゆ}",
    "氷": "氷{こおり}",
    "ご飯": "ご飯{はん}",
    "朝ご飯": "朝{あさ}ご飯{はん}",
    "昼ご飯": "昼{ひる}ご飯{はん}",
    "晩ご飯": "晩{ばん}ご飯{はん}",
    "お弁当": "お弁{べん}当{とう}",
    "料理": "料{りょう}理{り}",
    "お茶": "お茶{ちゃ}",
    "紅茶": "紅{こう}茶{ちゃ}",
    "酒": "酒{さけ}",
    "肉": "肉{にく}",
    "魚": "魚{さかな}",
    "野菜": "野{や}菜{さい}",
    "果物": "果{くだ}物{もの}",
    "卵": "卵{たまご}",
    "塩": "塩{しお}",
    "砂糖": "砂{さ}糖{とう}",
    "醤油": "醤{しょ}油{うゆ}",
    "手紙": "手{て}紙{がみ}",
    "切符": "切{きっ}符{ぷ}",
    "写真": "写{しゃ}真{しん}",
    "石鹸": "石{せっ}鹸{けん}",
    "映画": "映{えい}画{が}",
    "音楽": "音{おん}楽{がく}",
    "歌": "歌{うた}",
    "絵": "絵{え}",
    "言葉": "言{こと}葉{ば}",
    "字": "字{じ}",
    "日本語": "日{に}本{ほん}語{ご}",
    "英語": "英{えい}語{ご}",
    "何語": "何{なに}語{ご}",
    "質問": "質{しつ}問{もん}",
    "問題": "問{もん}題{だい}",
    "宿題": "宿{しゅく}題{だい}",
    "試験": "試{し}験{けん}",
    "用事": "用{よう}事{じ}",
    "約束": "約{やく}束{そく}",
    "仕事": "仕{し}事{ごと}",
    "お金": "お金{かね}",
    "荷物": "荷{に}物{もつ}",
    
    # Adjectives & Adverbs
    "大きい": "大{おお}きい",
    "小さい": "小{ちい}さい",
    "新しい": "新{あたら}しい",
    "古い": "古{ふる}い",
    "良い": "良{い}い",
    "悪い": "悪{わる}い",
    "暑い": "暑{あつ}い",
    "熱い": "熱{あつ}い",
    "寒い": "寒{さむ}い",
    "冷たい": "冷{つめ}たい",
    "難しい": "難{むずか}しい",
    "易しい": "易{やさ}しい",
    "高い": "高{たか}い",
    "安い": "安{やす}い",
    "低い": "低{ひく}い",
    "面白い": "面{おもし}白{ろ}い",
    "美味しい": "美{お}味{い}しい",
    "忙しい": "忙{いそが}しい",
    "楽しい": "楽{たの}しい",
    "白い": "白{しろ}い",
    "黒い": "黒{くろ}い",
    "赤い": "赤{あか}い",
    "青い": "青{あお}い",
    "近い": "近{ちか}い",
    "遠い": "遠{とお}い",
    "速い": "速{はや}い",
    "早い": "早{はや}い",
    "遅い": "遅{おそ}い",
    "多い": "多{おお}い",
    "少ない": "少{すく}ない",
    "温かい": "温{あたた}かい",
    "甘い": "甘{あま}い",
    "辛い": "辛{から}い",
    "苦い": "苦{にが}い",
    "重い": "重{おも}い",
    "軽い": "軽{かる}い",
    "狭い": "狭{せま}い",
    "広い": "広{ひろ}い",
    "痛い": "痛{いた}い",
    "欲しい": "欲{ほ}しい",
    "好き": "好{す}き",
    "嫌い": "嫌{きら}い",
    "上手": "上{じょう}手{ず}",
    "下手": "下{へ}手{た}",
    "得意": "得{とく}意{い}",
    "苦手": "苦{に}手{がて}",
    "綺麗": "綺{き}麗{れい}",
    "静か": "静{しず}か",
    "賑やか": "賑{にぎ}やか",
    "有名": "有{ゆう}名{めい}",
    "親切": "親{しん}切{せつ}",
    "元気": "元{げん}気{き}",
    "暇": "暇{ひま}",
    "便利": "便{べん}利{り}",
    "不便": "不{ふ}便{べん}",
    "大切": "大{たい}切{せつ}",
    "大丈夫": "大{だい}丈{じょう}夫{ぶ}",
    "危険": "危{き}険{けん}",
    "安全": "安{あん}全{ぜん}",
    "特別": "特{とく}別{べつ}",
    "簡単": "簡{かん}単{たん}",
    "色々": "色{いろ}々{いろ}",
    "同じ": "同{おな}じ",
    "結構": "結{けっ}構{こう}",
    "本当": "本{ほん}当{とう}",
    "多分": "多{た}分{ぶん}",
    "少し": "少{すこ}し",
    "全然": "全{ぜん}然{ぜん}",
    "全部": "全{ぜん}部{ぶ}",
    "一番": "一{いち}番{ばん}",
    
    # Verbs (Conjugations handled loosely by matching stem or full form)
    "行きます": "行{い}きます",
    "行く": "行{い}く",
    "行って": "行{い}って",
    "行った": "行{い}った",
    "来ます": "来{き}ます",
    "来る": "来{く}る",
    "来て": "来{き}て",
    "来た": "来{き}た",
    "来ない": "来{こ}ない",
    "帰ります": "帰{かえ}ります",
    "帰る": "帰{かえ}る",
    "帰って": "帰{かえ}って",
    "食べます": "食{た}べます",
    "食べる": "食{た}べる",
    "食べて": "食{た}べて",
    "飲みます": "飲{の}みます",
    "飲む": "飲{の}む",
    "飲んで": "飲{の}んで",
    "見ます": "見{み}みます", # Typo fixed below
    "見ます": "見{み}ます",
    "見る": "見{み}る",
    "見て": "見{み}て",
    "聞きます": "聞{き}きます",
    "聞く": "聞{き}く",
    "聞いて": "聞{き}いて",
    "読みます": "読{よ}みます",
    "読む": "読{よ}む",
    "読んで": "読{よ}んで",
    "書きます": "書{か}きます",
    "書く": "書{か}く",
    "書いて": "書{か}いて",
    "話します": "話{はな}します",
    "話す": "話{はな}す",
    "話して": "話{はな}して",
    "買います": "買{か}います",
    "買う": "買{か}う",
    "買って": "買{か}って",
    "取ります": "取{と}ります",
    "取る": "取{と}る",
    "待つ": "待{ま}つ",
    "待ちます": "待{ま}ちます",
    "待って": "待{ま}って",
    "会う": "会{あ}う",
    "会います": "会{あ}います",
    "会って": "会{あ}って",
    "呼ぶ": "呼{よ}ぶ",
    "呼びます": "呼{よ}びます",
    "住む": "住{す}む",
    "住んで": "住{す}んで",
    "入る": "入{はい}る",
    "入ります": "入{はい}ります",
    "入って": "入{はい}って",
    "出る": "出{で}る",
    "出ます": "出{で}ます",
    "置いて": "置{お}いて",
    "作る": "作{つく}る",
    "作ります": "作{つく}ります",
    "作って": "作{つく}って",
    "使う": "使{つか}う",
    "使って": "使{つか}って",
    "知る": "知{し}る",
    "知っています": "知{し}っています",
    "走る": "走{はし}る",
    "走って": "走{はし}って",
    "泳ぐ": "泳{およ}ぐ",
    "教える": "教{おし}える",
    "習う": "習{なら}う",
    "貸す": "貸{か}す",
    "借りる": "借{か}りる",
    "開ける": "開{あ}ける",
    "閉める": "閉{し}める",
    "開く": "開{あ}く",
    "閉まる": "閉{し}まる",
    "消える": "消{き}える",
    "消す": "消{け}す",
    "点ける": "点{つ}ける",
    "起きる": "起{お}きる",
    "寝る": "寝{ね}る",
    "浴びる": "浴{あ}びる",
    "働く": "働{はたら}く",
    "休む": "休{やす}む",
    "始まる": "始{はじ}まる",
    "終わる": "終{お}わる",
    "忘れる": "忘{わす}れる",
    "覚える": "覚{おぼ}える",
    "洗う": "洗{あら}う",
    "座る": "座{すわ}る",
    "立つ": "立{た}つ",
    "渡す": "渡{わた}す",
    "曲がる": "曲{ま}がる",
    "困る": "困{こま}る",
    "死ぬ": "死{し}ぬ",
    "遊ぶ": "遊{あそ}ぶ",
    "叱られる": "叱{しか}られる",
    "急いで": "急{いそ}いで",
    "遅れる": "遅{おく}れる",
    "晴れる": "晴{は}れる",
    "降る": "降{ふ}る",
    "曇る": "曇{くも}る",
    "咲く": "咲{さ}く",
    "掃除": "掃{そう}除{じ}",
    "洗濯": "洗{せん}濯{たく}",
    "練習": "練{れん}習{しゅう}",
    "散歩": "散{さん}歩{ぽ}",
    "結婚": "結{けっ}婚{こん}",
    "買い物": "買{か}い物{もの}",
    "入学": "入{にゅう}学{がく}",
    "卒業": "卒{そつ}業{ぎょう}",
        
    # Counters & Numbers
    "一つ": "一{ひと}つ",
    "二つ": "二{ふた}つ",
    "三つ": "三{みっ}つ",
    "四つ": "四{よっ}つ",
    "五つ": "五{いつ}つ",
    "六つ": "六{むっ}つ",
    "七つ": "七{なな}つ",
    "八つ": "八{やっ}つ",
    "九つ": "九{ここの}つ",
    "十": "十{とお}", # Context dependent, but usually 'too' for standalone counting or 'juu'
    "百": "百{ひゃく}",
    "千": "千{せん}",
    "万": "万{まん}",
    "円": "円{えん}",
    
    # Primitives/Suffixes that might appear
    "中": "中{なか}", # Contexts: 箱の中
    # "中" with "chuu/juu" handled if compound exists, else default to nana.
    # Be careful with single chars.
    
    # Specifics found in report
    "思い": "思{おも}い", # for 思い出
    "思い出": "思{おも}い出{で}",
    "何": "何{なに}", # Safe default? Or Nan?
    "何が": "何{なに}が",
    "何を": "何{なに}を",
    "一人暮らし": "一{ひと}人{り}暮{ぐ}らし",
    "風邪": "風{か}邪{ぜ}",
    "熱": "熱{ねつ}",
    "怖い": "怖{こわ}い",
    "差別": "差{さ}別{べつ}", # From question text
    "区別": "区{く}別{べつ}",
    "説明": "説{せつ}明{めい}",
    # Supplement based on Audit V2
    "頭": "頭{あたま}",
    "遅刻": "遅{ち}刻{こく}",
    "秋": "秋{あき}",
    "春": "春{はる}",
    "冬": "冬{ふゆ}",
    "長い": "長{なが}い",
    "短い": "短{みじか}い",
    "川": "川{かわ}",
    "見": "見{み}", # Carefully placed, might mask compounds if not sorted correctly. But we sort by len desc.
    "飲み": "飲{の}み",
    "行き": "行{い}き",
    "休み": "休{やす}み",
    "待ち": "待{ま}ち",
    "持ち": "持{も}ち",
    "帰り": "帰{かえ}り",
    "疲れ": "疲{つか}れ",
    "出発": "出{しゅっ}発{ぱつ}",
    "食事": "食{しょく}事{じ}",
    "今度": "今{こん}度{ど}",
    "紹介": "紹{しょう}介{かい}",
    "案内": "案{あん}内{ない}",
    "説明": "説{せつ}明{めい}",
    "準備": "準{じゅん}備{び}",
    "相談": "相{そう}談{だん}",
    "連絡": "連{れん}絡{らく}",
    "意味": "意{い}味{み}",
    "理由": "理{り}由{ゆう}",
    "場所": "場{ば}所{しょ}",
    "運動": "運{うん}動{どう}",
    "便利": "便{べん}利{り}",
    "不便": "不{ふ}便{べん}",
    "痛い": "痛{いた}い",
    "嫌い": "嫌{きら}い",
    "好き": "好{す}き",
    "欲しい": "欲{ほ}しい",
    "撮る": "撮{と}る",
    "撮り": "撮{と}り",
    "叱られ": "叱{しか}られ",
    "叱る": "叱{しか}る",
    "迷って": "迷{まよ}って",
    "迷う": "迷{まよ}う",
    "届き": "届{とど}き",
    "届く": "届{とど}く",
    "空": "空{そら}",
    "暗く": "暗{くら}く",
    "暗い": "暗{くら}い",
    "生活": "生{せい}活{かつ}",
    "関係": "関{かん}係{けい}",
    "貸し": "貸{か}し",
    "分かる": "分{わ}かる",
    "分かり": "分{わ}かり",
    "終わ": "終{お}わ", # for Owari/Owatte
    "始ま": "始{はじ}ま",
    "働く": "働{はたら}く",
    "働き": "働{はたら}き",
    "泳ぎ": "泳{およ}ぎ",
    "洗い": "洗{あら}い",
    "急ぎ": "急{いそ}ぎ",
    "遊び": "遊{あそ}び",
    "呼ぶ": "呼{よ}ぶ",
    "呼び": "呼{よ}び",
    "死ぬ": "死{し}ぬ",
    "死に": "死{し}に",
    "立ち": "立{た}ち",
    "座り": "座{すわ}り",
    "入っ": "入{はい}っ",
    "出る": "出{で}る",
    "出かけ": "出{で}かけ",
    "出せ": "出{だ}せ", # dashite
    "出し": "出{だ}し",
    "入れ": "入{い}れ",
    "切り": "切{き}り",
    "切る": "切{き}る",
    "教えて": "教{おし}えて",
    "並べ": "並{なら}べ",
    "並ぶ": "並{なら}ぶ",
    "並んで": "並{なら}んで",
    "脱ぐ": "脱{ぬ}ぐ",
    "脱いで": "脱{ぬ}いで",
    "履く": "履{は}く",
    "履いて": "履{は}いて",
    "被る": "被{かぶ}る",
    "被って": "被{かぶ}って",
    "眼鏡": "眼{め}鏡{がね}",
    "掛ける": "掛{か}ける",
    "掛けて": "掛{か}けて",
    "閉め": "閉{し}め",
    "閉まり": "閉{し}まり",
    "開け": "開{あ}け",
    "開き": "開{あ}き",
    "消し": "消{け}し",
    "点け": "点{つ}け",
    "乗る": "乗{の}る",
    "降りる": "降{お}りる",
    "乗り": "乗{の}り",
    "降り": "降{お}り",
    "生まれる": "生{う}まれる",
    "生まれ": "生{う}まれ",
    "住んで": "住{す}んで",
    "知って": "知{し}って",
    "思い": "思{お}もい", # Dupe check
    "持って": "持{も}って",
    "持つ": "持{も}つ",
    "待って": "待{ま}って",
    "待つ": "待{ま}つ",
    "行って": "行{い}って",
    "来て": "来{き}て",
    "帰って": "帰{かえ}って",
    "食べて": "食{た}べて",
    "飲んで": "飲{の}んで",
    "読んで": "読{よ}んで",
    "書いて": "書{か}いて",
    "買って": "買{か}って",
    "吸って": "吸{す}って",
    "吸う": "吸{す}う",
    "見て": "見{み}て",
    "聞いて": "聞{き}いて",
    "話して": "話{はな}して",
    "会って": "会{あ}って",
    "会う": "会{あ}う",
    "ある": "ある", # Kana
    "いる": "いる", # Kana
    
    # Adjectives
    "多い": "多{おお}い",
    "少ない": "少{すく}ない",
    "広い": "広{ひろ}い",
    "狭い": "狭{せま}い",
    "遠い": "遠{とお}い",
    "近い": "近{ちか}い",
    "遅い": "遅{おそ}い",
    "速い": "速{はや}い",
    "早い": "早{はや}い",
    "軽い": "軽{かる}い",
    "重い": "重{おも}い",
    "暗い": "暗{くら}い",
    "明るい": "明{あか}るい",
    "低": "低{ひく}", # stem
    "高": "高{たか}", # stem
    "短": "短{みじか}",
    "長": "長{なが}",
    "太": "太{ふと}",
    "細": "細{ほそ}",
    "若": "若{わか}",
    "忙": "忙{いそが}",
    "楽": "楽{たの}",
    "寒": "寒{さむ}",
    "暑": "暑{あつ}",
    "熱": "熱{あつ}",
    "冷": "冷{つめ}",
    "温": "温{あたた}",
    "涼": "涼{すず}",
    "難": "難{むずか}",
    "易": "易{やさ}",
    "甘": "甘{あま}",
    "辛": "辛{から}",
    "苦": "苦{にが}",
    "痛": "痛{いた}",
    "欲": "欲{ほ}",
    "好": "好{す}",
    "嫌": "嫌{きら}",
    "怖": "怖{こわ}",
    "汚": "汚{きたな}",
    
}

# Sort keys by length descending to handle "日本人" before "日本"
sorted_keys = sorted(replacements.keys(), key=len, reverse=True)

def add_furigana():
    files_updated = 0
    
    for file_path in files_to_update:
        if not os.path.exists(file_path):
            continue
            
        print(f"Processing {file_path}...")
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        original_content = content
        
        # We need to replace Kanji only if NOT followed by {
        # Using regex to ensure we don"t break existing annotations
        # Also need to ensure we don't replace "日本" inside "日本人{...}" if "日本人" wasn't matched first.
        # But we excluded blocks in audit. Here we want to Modify.
        # If we replace "日本" -> "日本{...}" inside "日本人{...}", it becomes "日本{...}人{...}" which is broken if braces mismatch.
        # Actually it becomes "日本{...}人" -> "日本{...}{...}人" ?
        # No.
        # Strategy:
        # 1. We tokenize the string into "Annotated Blocks" and "Text".
        # 2. We only modify "Text" parts.
        # 3. Reassemble.
        
        # Tokenizer regex: matches [Kanji+]{[Kana+]} OR anything else
        # Actually, simpler: split by valid blocks.
        
        # Pattern for valid block: ([一-龯々]+{[^}]+})
        parts = re.split(r'([一-龯々]+{[^}]+})', content)
        
        new_parts = []
        count = 0
        
        for part in parts:
            if re.match(r'[一-龯々]+{[^}]+}', part):
                # Is likely an existing annotated block, keep as is
                new_parts.append(part)
            else:
                # Text content, perform replacements here
                modified_part = part
                for key in sorted_keys:
                    if key in modified_part:
                        # Replace key with replacements[key]
                        # But only if not already annotated? We are in a "not annotated" block relative to known blocks.
                        # However, if we replace "日本" with "...", and then "一" with "...", we must be careful not to double replace.
                        # Since we iterate by length, "日本人" is processed before "日本", so it's safer.
                        # Simple replace valid?
                        # Yes, because `modified_part` does not contain `{}` used for furigana (except maybe unrelated braces? No, usage is `Kanji{Reading}`).
                        # But wait, what if `modified_part` contains `日本` and we replace it, then later `一`?
                        # `replacements["日本"]` = `日{に}本{ほん}`.
                        # `replacements["一"]` = `一{いち}`.
                        # If text is `日本一`, replace `日本` -> `日{に}本{ほん}一`.
                        # Then `一` -> `日{に}本{ほん}一{いち}`. This works.
                        # Issue: if key is `本`, and we already replaced `日本`, the `本` inside `本{ほん}` might be matched?
                        # Yes! `日{に}本{ほん}` contains "本".
                        # So we cannot simple replace sequentially in a loop over the string.
                        
                        # We must use a single pass tokenizer or regex for the candidates.
                        pass
                
                # Better approach for the text part:
                # Create a master regex of all keys: (Key1|Key2|...)
                # Replace with callback looking up dict.
                
                if not sorted_keys:
                    new_parts.append(part)
                    continue

                pattern = re.compile("|".join(map(re.escape, sorted_keys)))
                
                def replace_func(match):
                    return replacements[match.group(0)]
                
                # Perform replacement
                # We count changes
                subbed_text, n = pattern.subn(replace_func, modified_part)
                count += n
                new_parts.append(subbed_text)
                
        new_content = "".join(new_parts)
        
        if count > 0:
            print(f"  Made {count} annotations in {file_path}")
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            files_updated += 1
        else:
            print(f"  No changes in {file_path}")

if __name__ == "__main__":
    add_furigana()
